# TCCC Standard Event Schema

This document defines the standard event schema to be used by all components in the TCCC system. All modules must adhere to this schema when passing events between components.

## Base Event Schema

All events in the system must include these core properties:

```json
{
  "type": "event_type",          // Required: Event type identifier
  "timestamp": 1234567890.123,   // Required: Event creation time (epoch in seconds)
  "source": "component_name",    // Required: Source component identifier
  "session_id": "abc123",        // Required: Session identifier
  "sequence": 42,                // Optional: Event sequence number
  "metadata": { ... }            // Optional: Additional metadata
}
```

## Event Types

### Audio Events

#### Audio Segment Event
Generated by the Audio Pipeline when a new audio segment is available:

```json
{
  "type": "audio_segment",
  "timestamp": 1234567890.123,
  "source": "audio_pipeline",
  "session_id": "abc123",
  "sequence": 42,
  "data": {
    "audio": [...],                // Binary audio data as base64 or array
    "sample_rate": 16000,          // Sample rate in Hz
    "format": "PCM16",             // Audio format
    "channels": 1,                 // Number of audio channels
    "duration_ms": 500,            // Duration in milliseconds
    "is_speech": true,             // VAD result
    "start_time": 1234567880.123   // Start time of the segment
  },
  "metadata": {
    "source_device": "microphone", // Audio source device
    "noise_level_db": -30,         // Estimated background noise level
    "processing_ms": 15            // Processing time in milliseconds
  }
}
```

### Transcription Events

#### Transcription Event
Generated by the STT Engine when audio is transcribed:

```json
{
  "type": "transcription",
  "timestamp": 1234567890.123,
  "source": "stt_engine",
  "session_id": "abc123",
  "sequence": 43,
  "data": {
    "text": "Patient has tension pneumothorax",  // Transcribed text
    "segments": [                               // Detailed segments
      {
        "text": "Patient has tension pneumothorax",
        "start_time": 1234567885.123,
        "end_time": 1234567887.123,
        "confidence": 0.95,
        "words": [                              // Word-level details
          {
            "text": "tension",
            "start_time": 1234567886.123,
            "end_time": 1234567886.523,
            "confidence": 0.92
          },
          // More words...
        ]
      }
    ],
    "language": "en",                           // Detected language
    "confidence": 0.95                          // Overall confidence
  },
  "metadata": {
    "audio_duration_ms": 2000,                  // Duration of audio processed
    "processing_ms": 450,                       // Processing time
    "model": "whisper-medium"                   // Model used
  }
}
```

### Processing Events

#### Processed Text Event
Generated by the Processing Core after analyzing transcribed text:

```json
{
  "type": "processed_text",
  "timestamp": 1234567891.123,
  "source": "processing_core",
  "session_id": "abc123",
  "sequence": 44,
  "data": {
    "text": "Patient has tension pneumothorax",  // Original text
    "entities": [                               // Extracted entities
      {
        "text": "tension pneumothorax",
        "type": "MEDICAL_CONDITION",
        "start": 12,
        "end": 32,
        "confidence": 0.98
      }
    ],
    "intent": {                                 // Detected intent
      "name": "report_medical_condition",
      "confidence": 0.87,
      "slots": {
        "condition": "tension pneumothorax"
      }
    },
    "sentiment": {                              // Optional sentiment analysis
      "label": "urgent",
      "score": 0.85
    }
  },
  "metadata": {
    "processing_ms": 35                         // Processing time
  }
}
```

### LLM Analysis Events

#### LLM Analysis Event
Generated by the LLM Analysis module:

```json
{
  "type": "llm_analysis",
  "timestamp": 1234567892.123,
  "source": "llm_analysis",
  "session_id": "abc123",
  "sequence": 45,
  "data": {
    "summary": "Report of patient with tension pneumothorax requiring immediate treatment",
    "topics": ["tension pneumothorax", "chest trauma", "emergency"],
    "medical_terms": [
      {
        "term": "tension pneumothorax",
        "category": "medical_condition",
        "severity": "critical",
        "confidence": 0.98
      }
    ],
    "actions": [
      {
        "type": "treatment",
        "priority": "immediate",
        "description": "Needle decompression followed by chest tube placement"
      }
    ],
    "document_results": [                       // Related document results
      {
        "title": "Tension Pneumothorax Treatment",
        "relevance": 0.95,
        "snippet": "Tension pneumothorax requires immediate needle decompression..."
      }
    ]
  },
  "metadata": {
    "model": "phi-2",
    "processing_ms": 750,
    "tokens": 128
  }
}
```

### Document Events

#### Document Query Event
Generated when querying the Document Library:

```json
{
  "type": "document_query",
  "timestamp": 1234567893.123,
  "source": "llm_analysis",  // Source making the query
  "session_id": "abc123",
  "sequence": 46,
  "data": {
    "query": "tension pneumothorax treatment",  // Query text
    "filters": {                                // Optional filters
      "category": "medical_procedures",
      "min_relevance": 0.7
    },
    "limit": 3                                  // Maximum results
  },
  "metadata": {
    "context": "emergency"                      // Query context
  }
}
```

#### Document Results Event
Returned by the Document Library:

```json
{
  "type": "document_results",
  "timestamp": 1234567893.223,
  "source": "document_library",
  "session_id": "abc123",
  "sequence": 47,
  "data": {
    "query": "tension pneumothorax treatment",  // Original query
    "results": [
      {
        "id": "doc123",
        "title": "Tension Pneumothorax Treatment",
        "snippet": "Tension pneumothorax requires immediate needle decompression...",
        "relevance": 0.95,
        "category": "medical_procedures",
        "url": "file:///data/documents/tensions_pneumothorax.txt"
      }
      // More results...
    ],
    "result_count": 3,                          // Number of results
    "total_matches": 12                         // Total matches (before limit)
  },
  "metadata": {
    "processing_ms": 45                         // Query processing time
  }
}
```

### System Events

#### System Status Event
Generated periodically by the System:

```json
{
  "type": "system_status",
  "timestamp": 1234567895.123,
  "source": "system",
  "session_id": "abc123",
  "sequence": 50,
  "data": {
    "state": "ready",                           // System state
    "components": {                             // Component status
      "audio_pipeline": {"status": "ready", "uptime_sec": 120},
      "stt_engine": {"status": "ready", "uptime_sec": 120},
      "processing_core": {"status": "ready", "uptime_sec": 120},
      "llm_analysis": {"status": "ready", "uptime_sec": 120},
      "document_library": {"status": "ready", "uptime_sec": 120}
    },
    "resources": {                              // Resource usage
      "cpu_percent": 35.2,
      "memory_percent": 42.8,
      "gpu_utilization": 28.5
    }
  },
  "metadata": {
    "uptime_sec": 120                           // System uptime
  }
}
```

#### Error Event
Generated when an error occurs:

```json
{
  "type": "error",
  "timestamp": 1234567896.123,
  "source": "stt_engine",                       // Component reporting error
  "session_id": "abc123",
  "sequence": 51,
  "data": {
    "error_code": "audio_format_error",         // Error code
    "message": "Invalid audio format: expected PCM16, got PCM8",
    "severity": "warning",                      // Error severity
    "component": "audio_decoder",               // Specific component
    "recoverable": true                         // Is error recoverable
  },
  "metadata": {
    "traceback": "..."                          // Optional stack trace
  }
}
```

## Implementation Guidelines

1. All components MUST use this schema when generating or consuming events
2. All required fields MUST be present in every event
3. Event types MUST be one of the defined types (custom types should be requested)
4. Timestamp MUST be in epoch seconds with millisecond precision
5. Session ID MUST be consistent throughout a user session
6. Error handling MUST be implemented for invalid event formats

This schema can be extended with additional fields as needed, but the core structure must remain consistent.